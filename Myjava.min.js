document.addEventListener("DOMContentLoaded", function () {
    // Function to handle verification and redirection
    function handleVerification() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirectUrl = urlParams.get("redirect");

        if (redirectUrl) {
            sessionStorage.setItem("verifiedRedirect", redirectUrl);
            window.location.href = "/"; // Redirect to homepage for verification
        }
    }

    // Check if we're on the homepage
    if (window.location.pathname === "/") {
        const verifiedRedirect = sessionStorage.getItem("verifiedRedirect");
        if (verifiedRedirect) {
            sessionStorage.removeItem("verifiedRedirect"); // Clear stored URL
            window.location.href = verifiedRedirect; // Redirect to final link
        }
    }

    // Modify the link generation logic to include verification step
    document.getElementById("btngenerate").addEventListener("click", function () {
        const generateUrl = document.getElementById("generateurl").value;
        if (!generateUrl) {
            document.getElementById("generateurl").focus();
            return;
        }

        // Encrypt the URL and append verification redirect
        const encryptedUrl = aesCrypto.encrypt(convertstr(generateUrl), convertstr("root"));
        const safeLink = `/verify?redirect=${encodeURIComponent(encryptedUrl)}`;
        document.getElementById("resulturl").value = safeLink;
        document.getElementById("generatelink").classList.remove("hidden");
    });

    // If redirected for verification, handle it
    handleVerification();
});
